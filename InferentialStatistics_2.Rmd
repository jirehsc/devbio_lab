---
title: "Inferential"
author: "Planco"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  error = TRUE,     # Never quits on errors
  warning = FALSE, 
  message = FALSE,
  fig.width = 9, 
  fig.height = 5
)
par(mar = c(3,3,2,1))  

library(tidyverse)
library(car)
library(emmeans)
library(MASS)
library(janitor)


```

```{r}

#Loading data

md <- read.csv("metadata2.csv", header = TRUE)
names(md)


#install/loading packages

library(tidyverse)
library(dplyr)
library(dbplyr)
library(ggplot2)
library(pheatmap)
library(car)
library(emmeans)
library(lme4)
library(lmerTest)
library(janitor)

# Data Pipelining and Cleaning
################################

library(ggpubr)


#njchnfcjdnhc

###### DATA CLEANING ######

#import dataset

md <- read.csv("metadata2.csv", header = TRUE)

#load library
library(readxl)
library(tidyverse)
library(janitor)

#observe/ inspect data
###note: NA in columns: LFW,LDW, TW, RWC, WD 
###note: dead plants in 3 rows (specimenid: CX2, CY2, EY2,)

#data types and errors
# conversion to numeric to factor by column "block"
md$block <- as.factor(md$block)
#checking
class(md$block)
levels(md$block)

library(dplyr)
library(janitor)

clean <- md %>%
  clean_names() %>%  
  mutate(
    across(
      c(leaf_area, leaf_number, shoot_dry_weight, root_dry_weight, 
        shoot_fresh_weight, root_fresh_weight, leaf_fresh_weight, 
        leaf_dry_weight, turgid_weight, leaf_rwc, water_deficit, 
        plant_height, stem_diameter, shoot_length, root_length, 
        root_to_shoot_ratio, block_mortality_rate, block_survival_rate),
      ~ as.numeric(.x)
    ),
    specimen_id = as.character(specimen_id),
    block = as.factor(block)
  )


# Remove the dead 
clean <- clean %>%
  filter(
    !(coalesce(leaf_area, 0) == 0 &
        coalesce(leaf_number, 0) == 0 &
        coalesce(shoot_dry_weight, 0) == 0 &
        coalesce(root_dry_weight, 0) == 0)
  )

#verify
class(clean$block)
class(clean$ethanol_pre_treatment)
print(paste("Columns:", ncol(clean)))
print(paste("Rows:", nrow(clean)))
names(clean)


# Data Groupings ----------------------------------------------------------

md_groups <- clean %>%
  mutate(
    # convert to factors with labels
    saline_treatment = factor(
      saline_treatment,
      levels = c(0, 50, 100),
      labels = c("Control", "S1", "S2")
    ),
    ethanol_pre_treatment = factor(
      ethanol_pre_treatment,
      levels = c(0, 20),
      labels = c("None", "Ethanol")
    ),
    
    # create group labels
    group = case_when(
      saline_treatment == "Control" & ethanol_pre_treatment == "None"     ~ "CX",
      saline_treatment == "Control" & ethanol_pre_treatment == "Ethanol"  ~ "EX",
      saline_treatment == "S1"      & ethanol_pre_treatment == "None"     ~ "CY",
      saline_treatment == "S1"      & ethanol_pre_treatment == "Ethanol"  ~ "EY",
      saline_treatment == "S2"      & ethanol_pre_treatment == "None"     ~ "CZ",
      saline_treatment == "S2"      & ethanol_pre_treatment == "Ethanol"  ~ "EZ",
      TRUE ~ NA_character_
    )
  )

table(md_groups$group, useNA = "ifany")

#reference levels
md_groups <- md_groups %>%
  mutate(
    saline_treatment = relevel(saline_treatment, ref = "Control"),
    ethanol_pre_treatment = relevel(ethanol_pre_treatment, ref = "None")
  )

unique(clean$saline_treatment)
unique(clean$ethanol_pre_treatment)

clean <- clean %>% 
  mutate(
    saline_treatment = factor(saline_treatment,
                              levels = c("Control", "S1", "S2")),
    ethanol_pre_treatment = factor(ethanol_pre_treatment,
                                   levels = c("None", "Ethanol"))
  )

table(md_groups$group)

#data-splitting

group_dfs <- md_groups %>%
  filter(!is.na(group)) %>%
  split(.$group)

#assignment of dfs

CX <- group_dfs$CX   
EX <- group_dfs$EX   
CY <- group_dfs$CY   
EY <- group_dfs$EY   
CZ <- group_dfs$CZ   
EZ <- group_dfs$EZ   

```

```{r}
# 1. Meeting assumptions; Transformation of Data using log and box cox (Non-normal traits: Leaf_number, sfw, rfw)

  #Transform shoot fresh weight to normal using log
md_groups$log_shoot_fresh_weight <- log(md_groups$shoot_fresh_weight + 0.01)

  #Transform root fresh weight and leaf number to normal using box cox with plot
# Leaf number 
model_leaf <- lm((leaf_number + 0.5) ~ group + block, data = md_groups)
bc_leaf <- boxcox(model_leaf); lambda_leaf <- bc_leaf$x[which.max(bc_leaf$y)]
md_groups$bc_leaf_number <- ((md_groups$leaf_number + 0.5)^lambda_leaf - 1)/lambda_leaf

#qqplot
par(mfrow=c(1,2)); 
qqnorm(residuals(lm(leaf_number~group+block,md_groups)),main="Leaf Orig");qqline(residuals(lm(leaf_number~group+block,md_groups)),col="red")
qqnorm(residuals(lm(bc_leaf_number~group+block,md_groups)),main=paste("Leaf λ=",round(lambda_leaf,2)));qqline(residuals(lm(bc_leaf_number~group+block,md_groups)),col="blue")
par(mfrow=c(1,1))

# Root fresh weight 
model_rfw <- lm(root_fresh_weight ~ group + block, data = md_groups)
bc_rfw <- boxcox(model_rfw); lambda_rfw <- bc_rfw$x[which.max(bc_rfw$y)]
md_groups$bc_root_fresh_weight <- (md_groups$root_fresh_weight^lambda_rfw - 1)/lambda_rfw 

#qqplot 
par(mfrow=c(1,2))
qqnorm(residuals(lm(root_fresh_weight~group+block,md_groups)), main="RFW - Original"); qqline(residuals(lm(root_fresh_weight~group+block,md_groups)), col="red")
qqnorm(residuals(lm(bc_root_fresh_weight~group+block,md_groups)), main=paste("RFW Box-Cox λ=",round(lambda_rfw,2))); qqline(residuals(lm(bc_root_fresh_weight~group+block,md_groups)), col="blue")
par(mfrow=c(1,1))


```

```{r}
#2.check normality again with transformed data: summary table for all traits showing "NORMAL" or NON-NORMAL"

all_traits <- c("leaf_area", "bc_leaf_number", "shoot_dry_weight", "root_dry_weight", 
                "log_shoot_fresh_weight", "bc_root_fresh_weight", "plant_height", 
                "stem_diameter", "shoot_length", "root_length", "root_to_shoot_ratio")

normality_table <- data.frame(
  Trait = all_traits,
  Normal_Groups = sapply(all_traits, function(trait) {
    count <- 0
    for(g in c("CX","EX","CY","EY","CZ","EZ")) {
      x <- na.omit(md_groups[[trait]][md_groups$group == g])
      if(length(x) >= 3 && shapiro.test(x)$p.value > 0.05) count <- count + 1
    }
    count
  }),
  Prop = sapply(all_traits, function(trait) paste0(
    sum(sapply(c("CX","EX","CY","EY","CZ","EZ"), function(g){
      x <- na.omit(md_groups[[trait]][md_groups$group == g]); length(x)>=3 && shapiro.test(x)$p.value>0.05
    })), "/6")),
  Status = sapply(all_traits, function(trait) {
    n <- sum(sapply(c("CX","EX","CY","EY","CZ","EZ"), function(g){
      x <- na.omit(md_groups[[trait]][md_groups$group == g]); length(x)>=3 && shapiro.test(x)$p.value>0.05
    }))
    ifelse(n>=4, "NORMAL", "NON-NORMAL")
  })
); print(normality_table)


#make dataframe "norm_traits"

norm_traits <- md_groups[, c("leaf_area", "bc_leaf_number", "log_shoot_fresh_weight", 
                             "bc_root_fresh_weight", "shoot_dry_weight", "root_dry_weight", 
                             "plant_height", "stem_diameter", "shoot_length", "root_length", 
                             "root_to_shoot_ratio")]

norm_traits <- norm_traits[complete.cases(norm_traits), ]
norm_traits[, c("bc_leaf_number", "log_shoot_fresh_weight", "bc_root_fresh_weight")] <- 
  round(norm_traits[, c("bc_leaf_number", "log_shoot_fresh_weight", "bc_root_fresh_weight")], 4)

cat("\n=== NORM_TRAITS READY (NA-FREE, NO group/block) ===\n")
cat("Dimensions:", nrow(norm_traits), "rows x", ncol(norm_traits), "traits\n")
print(head(norm_traits))

# DEFINE traits_final
traits_final <- all_traits


```

```{r}
# 3. RCBD one-way anova 

#fit model
rcbd_models <- lapply(traits_final, function(trait) {
  formula <- as.formula(paste(trait, "~ group + block"))
  lm(formula, data = md_groups)
})

#apply to all traits
rcbd_anova_results <- lapply(rcbd_models, anova)
names(rcbd_anova_results) <- traits_final

#view result to each trait
cat("RCBD ANOVA RESULTS PER TRAIT:\n")
for(i in seq_along(rcbd_anova_results)) {
  cat("\n=== ", traits_final[i], " ===\n")
  print(rcbd_anova_results[[i]])
}



```

```{r}
# 4. Post hoc test for significant traits (p<0.05 ONLY). 

cat("\n=== POST-HOC TUKEYHSD (Leaf Area & Leaf Number Only) ===\n")

# Leaf Area
model_leaf_area <- aov(leaf_area ~ group + block, data = md_groups)
cat("Leaf Area ANOVA p =", format.pval(anova(model_leaf_area)$"Pr(>F)"[1]), "\n")
if(anova(model_leaf_area)$"Pr(>F)"[1] < 0.05) {
  cat("Leaf Area TukeyHSD:\n")
  print(TukeyHSD(model_leaf_area)$group[, "p adj"])
}

cat("\n")

# Leaf Number (transformed)
model_leaf_num <- aov(bc_leaf_number ~ group + block, data = md_groups)
cat("Leaf Number ANOVA p =", format.pval(anova(model_leaf_num)$"Pr(>F)"[1]), "\n")
if(anova(model_leaf_num)$"Pr(>F)"[1] < 0.05) {
  cat("Leaf Number TukeyHSD:\n")
  print(TukeyHSD(model_leaf_num)$group[, "p adj"])
}

#============================================================


```